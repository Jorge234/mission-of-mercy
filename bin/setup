#!/usr/bin/env sh

# Set up MoM app. Run this script immediately after cloning the codebase.

command_exists() {
  command -v "$1" &>/dev/null
}

has_ruby() {
  command_exists "ruby" && ruby -v | grep -q "$1"
}

# Check for qmake
if ! command_exists "qmake"; then
  exec >&2
  echo "\033[31m == We use capybara-webkit for testing our app ==\033[0m"
  echo "capybara-webkit depends on a WebKit implementation from Qt."
  echo "You'll need to download the Qt libraries to build and install the gem."
  echo "This page should help you get up and running:"
  echo "\n \033[4;34mhttps://github.com/thoughtbot/capybara-webkit#readme\033[0m\n"
  echo "Once that is installed, re-run this script to resume setup."
  exit 1
fi

# PostgreSQL is also an external dependency
if ! command_exists "psql"; then
  exec >&2
  echo "\033[31m == We use PostgreSQL as our database ==\033[0m"
  echo "The PostgreSQL database is needed in order to install the pg gem."
  echo "See the Wiki for instructions on how to install it on your operating system:"
  echo "\n \033[4;34mhttp://wiki.postgresql.org/wiki/Detailed_installation_guides\033[0m\n"
  echo "Once that is installed, re-run this script to resume setup."
  exit 1
fi

# Check Ruby 1.9.3 is installed.
if ! has_ruby "1.9.3"; then
  exec >&2
  echo "\033[31m == The application runs on Ruby 1.9.3 ==\033[0m"
  echo "In order to get the app running, you first need to install Ruby 1.9.3."
  echo "You can see more information on how to get it installed in the following page:"
  echo "\n \033[4;34mhttp://www.ruby-lang.org/en/downloads/\033[0m\n"
  echo "Once Ruby is installed, re-run this script to resume setup."
  exit 1
fi

# Set up Ruby dependencies
bundle install

# Set up upstream git remote
git remote add upstream git://github.com/mission-of-mercy/mission-of-mercy.git

# Set up config files and database
bundle exec rake setup

# Run the tests

bundle exec rake test
